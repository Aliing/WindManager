drop FUNCTION if exists f_sla_stats_roll_up(statusTime bigint);
CREATE OR REPLACE FUNCTION f_sla_stats_roll_up(statusTime bigint)
  RETURNS boolean AS
 $BODY$ 
 declare 
 sql varchar;
 r record;
 eFlg boolean :=false;
 c_apmac varchar :='';
 c_apname varchar :='';
 c_timestamp bigint :=0;
 c_apTotal_Red int :=0;
 c_apTotal_Yellow int :=0;
 c_apSla_Red int :=0;
 c_apSla_Yellow int :=0;
 c_apAirTime_Red int :=0;
 c_apCrcError_Red int :=0;
 c_apRetry_Red int :=0;
 c_apTxDrop_Red int :=0;
 c_apRxDrop_Red int :=0;
 c_clientTotal_Red int :=0;
 c_clientTotal_Yellow int :=0;
 c_clientSla_Red int :=0;
 c_clientSla_Yellow int :=0;
 c_clientAirTime_Red int :=0;
 c_clientScore_Red int :=0;
 c_clientScore_Yellow int :=0;
 c_owner bigint :=0;
 c_clientCount int :=0;
 clastTime bigint :=0;
 caCount int :=20;
 cNum int :=1;
 
 begin
	
	-- roll up hour table from min table, calculate the last time from hour table
	select into clastTime timestamp from ah_new_sla_stats_hour order by timestamp desc limit 1;
	
	if clastTime is null or clastTime = 0 then 
		sql := 'select * from ah_new_sla_stats where timestamp<= ' || statusTime || ' and timestamp> ' || statusTime-604800000 || ' order by owner, apmac, timestamp asc';
	else 
		sql := 'select * from ah_new_sla_stats where timestamp<= ' || statusTime || ' and timestamp> ' || clastTime || ' order by owner, apmac, timestamp asc';
	end if;
	select into caCount count(*) from ah_sla_stats where globalFlag=true and timestamp<= statusTime and timestamp> (statusTime - 3600000);
	if (caCount=0) then
		caCount :=20;
	end if;
	for r in execute sql loop
		if eFlg=false then
			c_apmac := r.apmac;
			c_apname := r.apname;
			if (r.timestamp%3600000=0) then
				c_timestamp := r.timestamp;
			else 
				c_timestamp := r.timestamp/3600000 * 3600000 + 3600000;
			end if;
			c_apTotal_Red := r.apTotal_Red;
			c_apTotal_Yellow := r.apTotal_Yellow;
			c_apSla_Red := r.apSla_Red;
			c_apSla_Yellow := r.apSla_Yellow;
			c_apAirTime_Red := r.apAirTime_Red;
			c_apCrcError_Red := r.apCrcError_Red;
			c_apRetry_Red := r.apRetry_Red;
			c_apTxDrop_Red := r.apTxDrop_Red;
			c_apRxDrop_Red := r.apRxDrop_Red;
			c_clientTotal_Red := r.clientTotal_Red * r.clientCount;
			c_clientTotal_Yellow := r.clientTotal_Yellow * r.clientCount;
			c_clientSla_Red :=r.clientSla_Red * r.clientCount;
			c_clientSla_Yellow := r.clientSla_Yellow * r.clientCount;
			c_clientAirTime_Red := r.clientAirTime_Red * r.clientCount;
			c_clientScore_Red := r.clientScore_Red * r.clientCount;
			c_clientScore_Yellow := r.clientScore_Yellow * r.clientCount;
			c_owner := r.owner;
			c_clientCount := r.clientCount;
			cNum :=1;
			eFlg:=true;
			continue;
		end if;

		if c_owner!= r.owner or c_apmac!= r.apmac or (r.timestamp - c_timestamp) >0 then
			if (c_clientCount=0) then
				insert into ah_new_sla_stats_hour (apmac,apname,apTotal_Red,apTotal_Yellow,apSla_Red,apSla_Yellow,
					apAirTime_Red,apCrcError_Red,apRetry_Red,apTxDrop_Red,apRxDrop_Red,clientTotal_Red,clientTotal_Yellow,
					clientSla_Red,clientSla_Yellow,clientAirTime_Red,clientScore_Red,clientScore_Yellow,timestamp,owner, version, clientCount)
					values(c_apmac,c_apname,c_apTotal_Red*100/caCount,c_apTotal_Yellow*100/caCount,c_apSla_Red*100/caCount,c_apSla_Yellow*100/caCount,
					c_apAirTime_Red*100/caCount,c_apCrcError_Red*100/caCount,c_apRetry_Red*100/caCount,c_apTxDrop_Red*100/caCount,c_apRxDrop_Red*100/caCount,
					0,0,0,0,
					0,0, 0,c_timestamp,c_owner, now(), c_clientCount/cNum);
			else 
				insert into ah_new_sla_stats_hour (apmac,apname,apTotal_Red,apTotal_Yellow,apSla_Red,apSla_Yellow,
					apAirTime_Red,apCrcError_Red,apRetry_Red,apTxDrop_Red,apRxDrop_Red,clientTotal_Red,clientTotal_Yellow,
					clientSla_Red,clientSla_Yellow,clientAirTime_Red,clientScore_Red,clientScore_Yellow,timestamp,owner, version, clientCount)
					values(c_apmac,c_apname,c_apTotal_Red*100/caCount,c_apTotal_Yellow*100/caCount,c_apSla_Red*100/caCount,c_apSla_Yellow*100/caCount,
					c_apAirTime_Red*100/caCount,c_apCrcError_Red*100/caCount,c_apRetry_Red*100/caCount,c_apTxDrop_Red*100/caCount,c_apRxDrop_Red*100/caCount,
					c_clientTotal_Red/c_clientCount,c_clientTotal_Yellow/c_clientCount,c_clientSla_Red/c_clientCount,c_clientSla_Yellow/c_clientCount,
					c_clientAirTime_Red/c_clientCount,c_clientScore_Red/c_clientCount, c_clientScore_Yellow/c_clientCount,c_timestamp,c_owner, now(), c_clientCount/cNum);
			end if;
			
			
			c_apmac := r.apmac;
			c_apname := r.apname;
			if (r.timestamp%3600000=0) then
				c_timestamp := r.timestamp;
			else 
				c_timestamp := r.timestamp/3600000 * 3600000 + 3600000;
			end if;
			c_apTotal_Red := r.apTotal_Red;
			c_apTotal_Yellow := r.apTotal_Yellow;
			c_apSla_Red := r.apSla_Red;
			c_apSla_Yellow := r.apSla_Yellow;
			c_apAirTime_Red := r.apAirTime_Red;
			c_apCrcError_Red := r.apCrcError_Red;
			c_apRetry_Red := r.apRetry_Red;
			c_apTxDrop_Red := r.apTxDrop_Red;
			c_apRxDrop_Red := r.apRxDrop_Red;
			c_clientTotal_Red := r.clientTotal_Red * r.clientCount;
			c_clientTotal_Yellow := r.clientTotal_Yellow * r.clientCount;
			c_clientSla_Red := r.clientSla_Red * r.clientCount;
			c_clientSla_Yellow := r.clientSla_Yellow * r.clientCount;
			c_clientAirTime_Red := r.clientAirTime_Red * r.clientCount;
			c_clientScore_Red := r.clientScore_Red * r.clientCount;
			c_clientScore_Yellow := r.clientScore_Yellow * r.clientCount;
			c_owner := r.owner;
			c_clientCount := r.clientCount;
			cNum :=1;
			continue;
		end if;
		c_apTotal_Red := c_apTotal_Red + r.apTotal_Red;
		c_apTotal_Yellow := c_apTotal_Yellow + r.apTotal_Yellow;
		c_apSla_Red := c_apSla_Red + r.apSla_Red;
		c_apSla_Yellow := c_apSla_Yellow + r.apSla_Yellow;
		c_apAirTime_Red := c_apAirTime_Red + r.apAirTime_Red;
		c_apCrcError_Red := c_apCrcError_Red + r.apCrcError_Red;
		c_apRetry_Red := c_apRetry_Red + r.apRetry_Red;
		c_apTxDrop_Red := c_apTxDrop_Red + r.apTxDrop_Red;
		c_apRxDrop_Red := c_apRxDrop_Red + r.apRxDrop_Red;
		c_clientTotal_Red := c_clientTotal_Red + r.clientTotal_Red * r.clientCount;
		c_clientTotal_Yellow := c_clientTotal_Yellow + r.clientTotal_Yellow * r.clientCount;
		c_clientSla_Red := c_clientSla_Red + r.clientSla_Red * r.clientCount;
		c_clientSla_Yellow := c_clientSla_Yellow + r.clientSla_Yellow * r.clientCount;
		c_clientAirTime_Red := c_clientAirTime_Red + r.clientAirTime_Red * r.clientCount;
		c_clientScore_Red := c_clientScore_Red + r.clientScore_Red * r.clientCount;
		c_clientScore_Yellow := c_clientScore_Yellow + r.clientScore_Yellow * r.clientCount;
		c_clientCount := c_clientCount + r.clientCount;
		cNum :=cNum + 1;
	end loop;

	if eFlg=true then
		if (c_clientCount=0) then
				insert into ah_new_sla_stats_hour (apmac,apname,apTotal_Red,apTotal_Yellow,apSla_Red,apSla_Yellow,
					apAirTime_Red,apCrcError_Red,apRetry_Red,apTxDrop_Red,apRxDrop_Red,clientTotal_Red,clientTotal_Yellow,
					clientSla_Red,clientSla_Yellow,clientAirTime_Red,clientScore_Red,clientScore_Yellow,timestamp,owner, version, clientCount)
					values(c_apmac,c_apname,c_apTotal_Red*100/caCount,c_apTotal_Yellow*100/caCount,c_apSla_Red*100/caCount,c_apSla_Yellow*100/caCount,
					c_apAirTime_Red*100/caCount,c_apCrcError_Red*100/caCount,c_apRetry_Red*100/caCount,c_apTxDrop_Red*100/caCount,c_apRxDrop_Red*100/caCount,
					0,0,0,0,
					0,0, 0,c_timestamp,c_owner, now(), c_clientCount/cNum);
			else 
				insert into ah_new_sla_stats_hour (apmac,apname,apTotal_Red,apTotal_Yellow,apSla_Red,apSla_Yellow,
					apAirTime_Red,apCrcError_Red,apRetry_Red,apTxDrop_Red,apRxDrop_Red,clientTotal_Red,clientTotal_Yellow,
					clientSla_Red,clientSla_Yellow,clientAirTime_Red,clientScore_Red,clientScore_Yellow,timestamp,owner, version, clientCount)
					values(c_apmac,c_apname,c_apTotal_Red*100/caCount,c_apTotal_Yellow*100/caCount,c_apSla_Red*100/caCount,c_apSla_Yellow*100/caCount,
					c_apAirTime_Red*100/caCount,c_apCrcError_Red*100/caCount,c_apRetry_Red*100/caCount,c_apTxDrop_Red*100/caCount,c_apRxDrop_Red*100/caCount,
					c_clientTotal_Red/c_clientCount,c_clientTotal_Yellow/c_clientCount,c_clientSla_Red/c_clientCount,c_clientSla_Yellow/c_clientCount,
					c_clientAirTime_Red/c_clientCount,c_clientScore_Red/c_clientCount, c_clientScore_Yellow/c_clientCount,c_timestamp,c_owner, now(), c_clientCount/cNum);
			end if;
	end if;

	-- roll up day table from hour table, calculate the last time from day table
	-- if the time is 0 clock.
	-- 3600000 * 24 
	caCount:=24;
	if statusTime%(86400000) =0 then

		eFlg:= false;

		select into clastTime timestamp from ah_new_sla_stats_day order by timestamp desc limit 1;

		if clastTime is null or clastTime = 0 then 
			-- sql := 'select * from hm_interface_stats_hour where timestamp< ' || statusTime || ' and timestamp>= ' || statusTime-3600000 * 24 * 7 || ' order by owner, apmac, timestamp';
			sql := 'select * from ah_new_sla_stats_hour where timestamp<= ' || statusTime || ' and timestamp> ' || statusTime-604800000 || ' order by owner, apmac, timestamp asc';
		else 
			sql := 'select * from ah_new_sla_stats_hour where timestamp<= ' || statusTime || ' and timestamp> ' || clastTime || ' order by owner, apmac, timestamp asc';
		end if;

		for r in execute sql loop
			if eFlg=false then
				c_apmac := r.apmac;
				c_apname := r.apname;
				-- 3600000 * 24
				if (r.timestamp%86400000=0) then
					c_timestamp := r.timestamp;
				else 
					c_timestamp := r.timestamp/(86400000) * 86400000 + 86400000;
				end if;
				
				c_apTotal_Red := r.apTotal_Red;
				c_apTotal_Yellow := r.apTotal_Yellow;
				c_apSla_Red := r.apSla_Red;
				c_apSla_Yellow := r.apSla_Yellow;
				c_apAirTime_Red := r.apAirTime_Red;
				c_apCrcError_Red := r.apCrcError_Red;
				c_apRetry_Red := r.apRetry_Red;
				c_apTxDrop_Red := r.apTxDrop_Red;
				c_apRxDrop_Red := r.apRxDrop_Red;
				c_clientTotal_Red := r.clientTotal_Red * r.clientCount;
				c_clientTotal_Yellow := r.clientTotal_Yellow * r.clientCount;
				c_clientSla_Red := r.clientSla_Red * r.clientCount;
				c_clientSla_Yellow := r.clientSla_Yellow * r.clientCount;
				c_clientAirTime_Red := r.clientAirTime_Red * r.clientCount;
				c_clientScore_Red := r.clientScore_Red * r.clientCount;
				c_clientScore_Yellow := r.clientScore_Yellow * r.clientCount;
				c_owner := r.owner;
				c_clientCount := r.clientCount;
				eFlg:=true;
				cNum :=1;
				continue;
			end if;
			if c_owner!= r.owner or c_apmac!= r.apmac or (r.timestamp - c_timestamp) >0 then
				if (c_clientCount=0) then
					insert into ah_new_sla_stats_day (apmac,apname,apTotal_Red,apTotal_Yellow,apSla_Red,apSla_Yellow,
						apAirTime_Red,apCrcError_Red,apRetry_Red,apTxDrop_Red,apRxDrop_Red,clientTotal_Red,clientTotal_Yellow,
						clientSla_Red,clientSla_Yellow,clientAirTime_Red,clientScore_Red,clientScore_Yellow,timestamp,owner, version, clientCount)
						values(c_apmac,c_apname,c_apTotal_Red/caCount,c_apTotal_Yellow/caCount,c_apSla_Red/caCount,c_apSla_Yellow/caCount,
						c_apAirTime_Red/caCount,c_apCrcError_Red/caCount,c_apRetry_Red/caCount,c_apTxDrop_Red/caCount,c_apRxDrop_Red/caCount,
						0,0,0,0,
						0,0, 0,c_timestamp,c_owner, now(), c_clientCount/cNum);
				else 
					insert into ah_new_sla_stats_day (apmac,apname,apTotal_Red,apTotal_Yellow,apSla_Red,apSla_Yellow,
						apAirTime_Red,apCrcError_Red,apRetry_Red,apTxDrop_Red,apRxDrop_Red,clientTotal_Red,clientTotal_Yellow,
						clientSla_Red,clientSla_Yellow,clientAirTime_Red,clientScore_Red,clientScore_Yellow,timestamp,owner, version, clientCount)
						values(c_apmac,c_apname,c_apTotal_Red/caCount,c_apTotal_Yellow/caCount,c_apSla_Red/caCount,c_apSla_Yellow/caCount,
						c_apAirTime_Red/caCount,c_apCrcError_Red/caCount,c_apRetry_Red/caCount,c_apTxDrop_Red/caCount,c_apRxDrop_Red/caCount,
						c_clientTotal_Red/c_clientCount,c_clientTotal_Yellow/c_clientCount,c_clientSla_Red/c_clientCount,c_clientSla_Yellow/c_clientCount,
						c_clientAirTime_Red/c_clientCount,c_clientScore_Red/c_clientCount, c_clientScore_Yellow/c_clientCount,c_timestamp,c_owner, now(), c_clientCount/cNum);
				end if;

				c_apmac := r.apmac;
				c_apname := r.apname;
				-- 3600000 * 24
				if (r.timestamp%86400000=0) then
					c_timestamp := r.timestamp;
				else 
					c_timestamp := r.timestamp/(86400000) * 86400000 + 86400000;
				end if;
				c_apTotal_Red := r.apTotal_Red;
				c_apTotal_Yellow := r.apTotal_Yellow;
				c_apSla_Red := r.apSla_Red;
				c_apSla_Yellow := r.apSla_Yellow;
				c_apAirTime_Red := r.apAirTime_Red;
				c_apCrcError_Red := r.apCrcError_Red;
				c_apRetry_Red := r.apRetry_Red;
				c_apTxDrop_Red := r.apTxDrop_Red;
				c_apRxDrop_Red := r.apRxDrop_Red;
				c_clientTotal_Red := r.clientTotal_Red * r.clientCount;
				c_clientTotal_Yellow := r.clientTotal_Yellow * r.clientCount;
				c_clientSla_Red := r.clientSla_Red * r.clientCount;
				c_clientSla_Yellow := r.clientSla_Yellow * r.clientCount;
				c_clientAirTime_Red := r.clientAirTime_Red * r.clientCount;
				c_clientScore_Red := r.clientScore_Red * r.clientCount;
				c_clientScore_Yellow := r.clientScore_Yellow * r.clientCount;
				c_owner := r.owner;
				c_clientCount := r.clientCount;
				cNum :=1;
				continue;
			end if;
			c_apTotal_Red := c_apTotal_Red + r.apTotal_Red;
			c_apTotal_Yellow := c_apTotal_Yellow + r.apTotal_Yellow;
			c_apSla_Red := c_apSla_Red + r.apSla_Red;
			c_apSla_Yellow := c_apSla_Yellow + r.apSla_Yellow;
			c_apAirTime_Red := c_apAirTime_Red + r.apAirTime_Red;
			c_apCrcError_Red := c_apCrcError_Red + r.apCrcError_Red;
			c_apRetry_Red := c_apRetry_Red + r.apRetry_Red;
			c_apTxDrop_Red := c_apTxDrop_Red + r.apTxDrop_Red;
			c_apRxDrop_Red := c_apRxDrop_Red + r.apRxDrop_Red;
			c_clientTotal_Red := c_clientTotal_Red + r.clientTotal_Red * r.clientCount;
			c_clientTotal_Yellow := c_clientTotal_Yellow + r.clientTotal_Yellow * r.clientCount;
			c_clientSla_Red := c_clientSla_Red + r.clientSla_Red * r.clientCount;
			c_clientSla_Yellow := c_clientSla_Yellow + r.clientSla_Yellow * r.clientCount;
			c_clientAirTime_Red := c_clientAirTime_Red + r.clientAirTime_Red * r.clientCount;
			c_clientScore_Red := c_clientScore_Red + r.clientScore_Red * r.clientCount;
			c_clientScore_Yellow := c_clientScore_Yellow + r.clientScore_Yellow * r.clientCount;
			c_clientCount := c_clientCount + r.clientCount;
			cNum :=cNum + 1;
		end loop;

		if eFlg=true then
				if (c_clientCount=0) then
					insert into ah_new_sla_stats_day (apmac,apname,apTotal_Red,apTotal_Yellow,apSla_Red,apSla_Yellow,
						apAirTime_Red,apCrcError_Red,apRetry_Red,apTxDrop_Red,apRxDrop_Red,clientTotal_Red,clientTotal_Yellow,
						clientSla_Red,clientSla_Yellow,clientAirTime_Red,clientScore_Red,clientScore_Yellow,timestamp,owner, version, clientCount)
						values(c_apmac,c_apname,c_apTotal_Red/caCount,c_apTotal_Yellow/caCount,c_apSla_Red/caCount,c_apSla_Yellow/caCount,
						c_apAirTime_Red/caCount,c_apCrcError_Red/caCount,c_apRetry_Red/caCount,c_apTxDrop_Red/caCount,c_apRxDrop_Red/caCount,
						0,0,0,0,
						0,0, 0,c_timestamp,c_owner, now(), c_clientCount/cNum);
				else 
					insert into ah_new_sla_stats_day (apmac,apname,apTotal_Red,apTotal_Yellow,apSla_Red,apSla_Yellow,
						apAirTime_Red,apCrcError_Red,apRetry_Red,apTxDrop_Red,apRxDrop_Red,clientTotal_Red,clientTotal_Yellow,
						clientSla_Red,clientSla_Yellow,clientAirTime_Red,clientScore_Red,clientScore_Yellow,timestamp,owner, version, clientCount)
						values(c_apmac,c_apname,c_apTotal_Red/caCount,c_apTotal_Yellow/caCount,c_apSla_Red/caCount,c_apSla_Yellow/caCount,
						c_apAirTime_Red/caCount,c_apCrcError_Red/caCount,c_apRetry_Red/caCount,c_apTxDrop_Red/caCount,c_apRxDrop_Red/caCount,
						c_clientTotal_Red/c_clientCount,c_clientTotal_Yellow/c_clientCount,c_clientSla_Red/c_clientCount,c_clientSla_Yellow/c_clientCount,
						c_clientAirTime_Red/c_clientCount,c_clientScore_Red/c_clientCount, c_clientScore_Yellow/c_clientCount,c_timestamp,c_owner, now(), c_clientCount/cNum);
				end if;
		end if;
	end if;

	-- roll up week table from day table, calculate the last time from week table
	-- if the time is 0 clock.
	-- 604800000 = 3600000* 24 * 7
	caCount:=7;
	if statusTime % (604800000) = 259200000 then

		eFlg:= false;

		select into clastTime timestamp from ah_new_sla_stats_week order by timestamp desc limit 1;

		if clastTime is null or clastTime = 0 then 
			sql := 'select * from ah_new_sla_stats_day where timestamp<= ' || statusTime || ' and timestamp> ' || statusTime-7776000000 || ' order by owner, apmac, timestamp asc';
			--sql := 'select * from hm_interface_stats_day where timestamp<= ' || statusTime || ' and timestamp> ' || statusTime-3600000 * 24 * 90 || ' owner, apmac, timestamp asc';
		else 
			sql := 'select * from ah_new_sla_stats_day where timestamp<= ' || statusTime || ' and timestamp> ' || clastTime || ' order by owner, apmac, timestamp asc';
		end if;

		for r in execute sql loop
			if eFlg=false then
				c_apmac := r.apmac;
				c_apname := r.apname;
				if (r.timestamp%(604800000)<=259200000) then
					c_timestamp := r.timestamp /604800000 * 604800000 + 259200000;
				else 
					c_timestamp := r.timestamp /604800000 * 604800000 + 604800000 + 259200000;
				end if;
				c_apTotal_Red := r.apTotal_Red;
				c_apTotal_Yellow := r.apTotal_Yellow;
				c_apSla_Red := r.apSla_Red;
				c_apSla_Yellow := r.apSla_Yellow;
				c_apAirTime_Red := r.apAirTime_Red;
				c_apCrcError_Red := r.apCrcError_Red;
				c_apRetry_Red := r.apRetry_Red;
				c_apTxDrop_Red := r.apTxDrop_Red;
				c_apRxDrop_Red := r.apRxDrop_Red;
				c_clientTotal_Red := r.clientTotal_Red * r.clientCount;
				c_clientTotal_Yellow := r.clientTotal_Yellow * r.clientCount;
				c_clientSla_Red := r.clientSla_Red * r.clientCount;
				c_clientSla_Yellow := r.clientSla_Yellow * r.clientCount;
				c_clientAirTime_Red := r.clientAirTime_Red * r.clientCount;
				c_clientScore_Red := r.clientScore_Red * r.clientCount;
				c_clientScore_Yellow := r.clientScore_Yellow * r.clientCount;
				c_owner := r.owner;
				c_clientCount :=r.clientCount;
				eFlg:=true;
				cNum :=1;
				continue;
			end if;
			if c_owner!= r.owner or c_apmac!= r.apmac or (r.timestamp - c_timestamp) >0 then
				if (c_clientCount=0) then
					insert into ah_new_sla_stats_week (apmac,apname,apTotal_Red,apTotal_Yellow,apSla_Red,apSla_Yellow,
						apAirTime_Red,apCrcError_Red,apRetry_Red,apTxDrop_Red,apRxDrop_Red,clientTotal_Red,clientTotal_Yellow,
						clientSla_Red,clientSla_Yellow,clientAirTime_Red,clientScore_Red,clientScore_Yellow,timestamp,owner, version, clientCount)
						values(c_apmac,c_apname,c_apTotal_Red/caCount,c_apTotal_Yellow/caCount,c_apSla_Red/caCount,c_apSla_Yellow/caCount,
						c_apAirTime_Red/caCount,c_apCrcError_Red/caCount,c_apRetry_Red/caCount,c_apTxDrop_Red/caCount,c_apRxDrop_Red/caCount,
						0,0,0,0,
						0,0, 0,c_timestamp,c_owner, now(), c_clientCount/cNum);
				else 
					insert into ah_new_sla_stats_week (apmac,apname,apTotal_Red,apTotal_Yellow,apSla_Red,apSla_Yellow,
						apAirTime_Red,apCrcError_Red,apRetry_Red,apTxDrop_Red,apRxDrop_Red,clientTotal_Red,clientTotal_Yellow,
						clientSla_Red,clientSla_Yellow,clientAirTime_Red,clientScore_Red,clientScore_Yellow,timestamp,owner, version, clientCount)
						values(c_apmac,c_apname,c_apTotal_Red/caCount,c_apTotal_Yellow/caCount,c_apSla_Red/caCount,c_apSla_Yellow/caCount,
						c_apAirTime_Red/caCount,c_apCrcError_Red/caCount,c_apRetry_Red/caCount,c_apTxDrop_Red/caCount,c_apRxDrop_Red/caCount,
						c_clientTotal_Red/c_clientCount,c_clientTotal_Yellow/c_clientCount,c_clientSla_Red/c_clientCount,c_clientSla_Yellow/c_clientCount,
						c_clientAirTime_Red/c_clientCount,c_clientScore_Red/c_clientCount, c_clientScore_Yellow/c_clientCount,c_timestamp,c_owner, now(), c_clientCount/cNum);
				end if;

				c_apmac := r.apmac;
				c_apname := r.apname;
				if (r.timestamp%(604800000)<=259200000) then
					c_timestamp := r.timestamp /604800000 * 604800000 + 259200000;
				else 
					c_timestamp := r.timestamp /604800000 * 604800000 + 604800000 + 259200000;
				end if;
				c_apTotal_Red := r.apTotal_Red;
				c_apTotal_Yellow := r.apTotal_Yellow;
				c_apSla_Red := r.apSla_Red;
				c_apSla_Yellow := r.apSla_Yellow;
				c_apAirTime_Red := r.apAirTime_Red;
				c_apCrcError_Red := r.apCrcError_Red;
				c_apRetry_Red := r.apRetry_Red;
				c_apTxDrop_Red := r.apTxDrop_Red;
				c_apRxDrop_Red := r.apRxDrop_Red;
				c_clientTotal_Red := r.clientTotal_Red * r.clientCount;
				c_clientTotal_Yellow := r.clientTotal_Yellow * r.clientCount;
				c_clientSla_Red := r.clientSla_Red * r.clientCount;
				c_clientSla_Yellow := r.clientSla_Yellow * r.clientCount;
				c_clientAirTime_Red := r.clientAirTime_Red * r.clientCount;
				c_clientScore_Red := r.clientScore_Red * r.clientCount;
				c_clientScore_Yellow := r.clientScore_Yellow * r.clientCount;
				c_owner := r.owner;
				c_clientCount := r.clientCount;
				cNum :=1;
				continue;
			end if;
			c_apTotal_Red := c_apTotal_Red + r.apTotal_Red;
			c_apTotal_Yellow := c_apTotal_Yellow + r.apTotal_Yellow;
			c_apSla_Red := c_apSla_Red + r.apSla_Red;
			c_apSla_Yellow := c_apSla_Yellow + r.apSla_Yellow;
			c_apAirTime_Red := c_apAirTime_Red + r.apAirTime_Red;
			c_apCrcError_Red := c_apCrcError_Red + r.apCrcError_Red;
			c_apRetry_Red := c_apRetry_Red + r.apRetry_Red;
			c_apTxDrop_Red := c_apTxDrop_Red + r.apTxDrop_Red;
			c_apRxDrop_Red := c_apRxDrop_Red + r.apRxDrop_Red;
			c_clientTotal_Red := c_clientTotal_Red + r.clientTotal_Red * r.clientCount;
			c_clientTotal_Yellow := c_clientTotal_Yellow + r.clientTotal_Yellow * r.clientCount;
			c_clientSla_Red := c_clientSla_Red + r.clientSla_Red * r.clientCount;
			c_clientSla_Yellow := c_clientSla_Yellow + r.clientSla_Yellow * r.clientCount;
			c_clientAirTime_Red := c_clientAirTime_Red + r.clientAirTime_Red * r.clientCount;
			c_clientScore_Red := c_clientScore_Red + r.clientScore_Red * r.clientCount;
			c_clientScore_Yellow := c_clientScore_Yellow + r.clientScore_Yellow * r.clientCount;
			c_clientCount := c_clientCount + r.clientCount;
			cNum :=cNum + 1;
		end loop;

		if eFlg=true then
				if (c_clientCount=0) then
					insert into ah_new_sla_stats_week (apmac,apname,apTotal_Red,apTotal_Yellow,apSla_Red,apSla_Yellow,
						apAirTime_Red,apCrcError_Red,apRetry_Red,apTxDrop_Red,apRxDrop_Red,clientTotal_Red,clientTotal_Yellow,
						clientSla_Red,clientSla_Yellow,clientAirTime_Red,clientScore_Red,clientScore_Yellow,timestamp,owner, version, clientCount)
						values(c_apmac,c_apname,c_apTotal_Red/caCount,c_apTotal_Yellow/caCount,c_apSla_Red/caCount,c_apSla_Yellow/caCount,
						c_apAirTime_Red/caCount,c_apCrcError_Red/caCount,c_apRetry_Red/caCount,c_apTxDrop_Red/caCount,c_apRxDrop_Red/caCount,
						0,0,0,0,
						0,0, 0,c_timestamp,c_owner, now(), c_clientCount/cNum);
				else 
					insert into ah_new_sla_stats_week (apmac,apname,apTotal_Red,apTotal_Yellow,apSla_Red,apSla_Yellow,
						apAirTime_Red,apCrcError_Red,apRetry_Red,apTxDrop_Red,apRxDrop_Red,clientTotal_Red,clientTotal_Yellow,
						clientSla_Red,clientSla_Yellow,clientAirTime_Red,clientScore_Red,clientScore_Yellow,timestamp,owner, version, clientCount)
						values(c_apmac,c_apname,c_apTotal_Red/caCount,c_apTotal_Yellow/caCount,c_apSla_Red/caCount,c_apSla_Yellow/caCount,
						c_apAirTime_Red/caCount,c_apCrcError_Red/caCount,c_apRetry_Red/caCount,c_apTxDrop_Red/caCount,c_apRxDrop_Red/caCount,
						c_clientTotal_Red/c_clientCount,c_clientTotal_Yellow/c_clientCount,c_clientSla_Red/c_clientCount,c_clientSla_Yellow/c_clientCount,
						c_clientAirTime_Red/c_clientCount,c_clientScore_Red/c_clientCount, c_clientScore_Yellow/c_clientCount,c_timestamp,c_owner, now(), c_clientCount/cNum);
				end if;
		end if;
	end if;

	return true;
 end;
 $BODY$
 LANGUAGE 'plpgsql' VOLATILE;