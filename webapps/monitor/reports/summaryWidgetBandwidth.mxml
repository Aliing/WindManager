<?xml version="1.0"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" creationComplete="init()"
			paddingLeft="0" paddingTop="0" paddingRight="0" paddingBottom="0">

	<mx:HTTPService id="httpSvc"/>

	<mx:Script>
        <![CDATA[
			import flash.utils.Timer;
			import mx.controls.Alert;
			import flash.net.navigateToURL;
			import mx.charts.HitData;
			import mx.charts.events.ChartItemEvent;
			import mx.rpc.events.ResultEvent;
			
			private var initURL: String; 
			private var timeFinishedFlg: Boolean=true;
			
			public function init():void {
				if (Application.application.url.indexOf("monitor/reports")>=0){
					initURL = Application.application.url.substring(0, Application.application.url.indexOf("monitor/reports"));
				} else {
					initURL="";
				}
				httpSvc.url = initURL+ "reports.action?operation=summaryWidgetBandwidthData&key=" + new Date().time;
				httpSvc.send();				
				refreshTimer();
    	 	}

			public function refreshTimer():void {
				// refresh for 15 * 60 secs = 15 minutes
            	var myTimer:Timer = new Timer(900000, 1);            	
				myTimer.addEventListener("timer", refreshHandler);
				myTimer.start();
        	}

			public function refreshHandler(event:TimerEvent):void {
				if (timeFinishedFlg){
					httpSvc.url = initURL+"reports.action?operation=summaryWidgetBandwidthData&key=" + new Date().time;
					httpSvc.addEventListener("result", httpResult);
					timeFinishedFlg=false;
					httpSvc.send();
				}
        	}
        	
        	public function httpResult(event:ResultEvent):void {
        		timeFinishedFlg=true;
        	}
			
            public function dateParseFunction(s:String):Date { 
			    var temp:Array = s.split(" ");    
			    var datepart:String = temp[0];    
			    var datearray:Array = datepart.split("-"); 
			    var timepart:String = temp[1];    
			    var timearray:Array = timepart.split(":");   
			    var intMon:int =datearray[1];
			    var intDay:int =datearray[2];
			    var intHour:int =timearray[0];
			    var intMin:int =timearray[1]; 
		     
		        var testDate:Date = new Date();
		    	var offhour:Number = testDate.getTimezoneOffset()/60 *-1;
		    	var offmin:Number = testDate.getTimezoneOffset()%60 *-1
		      	var newDate:Date = new Date(datearray[0],intMon-1,intDay,intHour+offhour,intMin+offmin);   
		      	
		      	return newDate;    
            }
            
            public function defineVerticalLabel(cat:Object,  pcat:Object, ax:LinearAxis):String 
			  {
			  		if (parseFloat(cat.toString()) > 500000000) {
			  			return (parseFloat(cat.toString())/1000000000) + " GB";
			  		} else if (parseFloat(cat.toString()) > 500000) {
			  			return (parseFloat(cat.toString())/1000000) + " MB";
					} else if (parseFloat(cat.toString()) > 500) {
			  			return (parseFloat(cat.toString())/1000) + " KB";
			  		} else {
			  			return cat.toString() + " Bytes";
			  		}
			  }
			public function dataDisplayFunction(e:HitData):String {
		       	var s:String;
		        s = "<B>" + LineSeries(e.element).displayName + "</B>\n";
		        s += "<I>Date Time:</I>" + e.item.date + "\n";
		        
		        if (parseFloat(e.item.count) > 500000000) {
		        		s += "<I>Value:</I>" + (parseFloat(e.item.count)/1000000000) + " GB" + "\n";
			  		} else if (parseFloat(e.item.count) > 500000) {
			  			s += "<I>Value:</I>" + (parseFloat(e.item.count)/1000000) + " MB" + "\n";
					} else if (parseFloat(e.item.count) > 500) {
			  			s += "<I>Value:</I>" + (parseFloat(e.item.count)/1000) + " KB" + "\n";
			  		} else {
			  			s += "<I>Value:</I>" + e.item.count + " Bytes" + "\n";
			  	}
		        return s
		    }
        ]]>
    </mx:Script>
    <mx:Panel height="100%" width="100%" verticalGap="0" headerHeight="0" borderThicknessBottom="0" borderThicknessLeft="0" borderThicknessRight="0" borderThicknessTop="0" borderStyle="none">
		<mx:LineChart height="100%" id="bandwidthData" width="100%"
    	    paddingRight="5" paddingLeft="5" 
    	    dataTipFunction="dataDisplayFunction"
        	showDataTips="true">
        	<mx:seriesFilters>
	           <mx:Array/>
	        </mx:seriesFilters>
            <mx:horizontalAxis>
	            <mx:DateTimeAxis
	            	dataUnits="milliseconds"
	            	labelUnits="hours" interval="1"
	            	parseFunction="dateParseFunction"/>
    	    </mx:horizontalAxis>

        	<mx:verticalAxis>
            	<mx:LinearAxis baseAtZero="true" labelFunction="defineVerticalLabel"/>
            </mx:verticalAxis>

	        <mx:series>
    	        <mx:LineSeries yField="count" xField="date" id="bindWidthDataSeries" dataProvider="{httpSvc.lastResult.summary.bindWidthRate.item}"
						displayName="Data Usage">
		            <mx:lineStroke>
		                <mx:Stroke color="0x0000FF"/>
		            </mx:lineStroke>   
				</mx:LineSeries>
        	</mx:series>
        </mx:LineChart> 
        <mx:Legend dataProvider="{bandwidthData}" x="50" width="100%" height="20" markerHeight="6"/>

	</mx:Panel>
</mx:Application>
