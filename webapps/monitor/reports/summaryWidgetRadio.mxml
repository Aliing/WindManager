<?xml version="1.0"?>
<mx:Application xmlns:mx="http://www.adobe.com/2006/mxml" creationComplete="init()"
			paddingLeft="0" paddingTop="0" paddingRight="0" paddingBottom="0">

	<mx:HTTPService id="httpSvc"/>

	<mx:Script>
        <![CDATA[
			import flash.utils.Timer;
			import mx.controls.Alert;
			import flash.net.navigateToURL;
			import mx.charts.HitData;
			import mx.charts.events.ChartItemEvent;
			import mx.rpc.events.ResultEvent;
			
			private var initURL: String; 
			private var timeFinishedFlg: Boolean=true;
			
	        public function displayClientsByType(data:Object, field:String, index:Number, percentValue:Number):String {
    	        var temp:String = (" " + percentValue).substr(0,6);
        	    return data.wlanType + ": " + data.count + '\n' + temp + "%";
        	}
		    
			public function init():void {
				if (Application.application.url.indexOf("monitor/reports")>=0){
					initURL = Application.application.url.substring(0, Application.application.url.indexOf("monitor/reports"));
				} else {
					initURL="";
				}
				httpSvc.url = initURL+"reports.action?operation=summaryWidgetRadioData&key=" + new Date().time;
				httpSvc.send();				
	            var explodeData:Array = [];
	            explodeData[0] = 0.15;
				clientsSeries.perWedgeExplodeRadius = explodeData;
				refreshTimer();
    	 	}

			public function refreshTimer():void {
				// refresh for 15 * 60 secs = 15 minutes
            	var myTimer:Timer = new Timer(180000, 5);            	
				myTimer.addEventListener("timer", refreshHandler);
				myTimer.start();
        	}

			public function refreshHandler(event:TimerEvent):void {
				if (timeFinishedFlg){
					httpSvc.url = initURL+"reports.action?operation=summaryWidgetRadioData&key=" + new Date().time;
					httpSvc.addEventListener("result", httpResult);
					timeFinishedFlg=false;
					httpSvc.send();
				}
        	}
        	
        	public function httpResult(event:ResultEvent):void {
        		timeFinishedFlg=true;
        	}
        	
	        private function formatClientsTip(hitData:HitData):String {
	        	var wlanType:String = "802." + hitData.item.wlanType;
	        	if (hitData.item.wlanType=="wired") {
	        		wlanType = "wired";
	        	}
				var count:int = hitData.item.count;
				return "<b>" + wlanType + ":  " + count + "</b>";
			}

			public function clientsView(event:ChartItemEvent):void {
				var index:int;
				switch(event.hitData.item.wlanType) {
					case "11a" :
						index = 0;
						break;
					case "11b" :
						index = 1;
						break;
					case "11g" :
						index = 2;
						break;
					case "11na" :
						index = 3;
						break;
					case "11ng" :
						index = 4;
						break;
					case "wired" :
						index = 5;
						break;
					default :
						index = 0;
						break;
				}
	            var explodeData:Array = [];
				if (clientsSeries.perWedgeExplodeRadius.length == 0 ||
				    clientsSeries.perWedgeExplodeRadius[index] != 0.15) {
	    	        explodeData[index] = 0.15;
	    	        clientsSeries.perWedgeExplodeRadius = explodeData;
				}
			}
        ]]>
    </mx:Script>

    <mx:Panel height="100%" width="100%" verticalGap="0" headerHeight="0" borderThicknessBottom="0" borderThicknessLeft="0" borderThicknessRight="0" borderThicknessTop="0" borderStyle="none">
		<mx:PieChart height="100%" width="100%" 
        	paddingRight="5" paddingLeft="5" itemClick="clientsView(event);"
        	dataTipFunction="formatClientsTip"
        	showDataTips="true" dataProvider="{httpSvc.lastResult.summary.clients.item}" > 
        	<mx:series>
            	<mx:PieSeries labelPosition="callout" field="count"
            			labelFunction="displayClientsByType" id="clientsSeries">
                	<mx:calloutStroke>
                    	<mx:Stroke weight="0" color="0x888888" alpha="1.0"/>
                	</mx:calloutStroke>
                	<mx:radialStroke>
                    	<mx:Stroke weight="0" color="#FFFFFF" alpha="0.20"/>
                	</mx:radialStroke>
                	<mx:stroke>
                    	<mx:Stroke color="0" alpha="0.20" weight="2"/>
                	</mx:stroke>
            	</mx:PieSeries>
        	</mx:series>            	
    	</mx:PieChart>
	</mx:Panel>
</mx:Application>
